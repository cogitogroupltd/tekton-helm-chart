{{- if .Values.pipelines }}
{{- range $value := .Values.pipelines }}
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: {{ $value.name }}
  namespace: {{ $.Release.Namespace }}
spec:
  params:
  - name: git_revision
    description: The git revision
  - name: git_revision_owner
    description: The owner of the git revision
  workspaces:
    - name: git-pvc
    - name: ssh-creds
    - name: docker-creds-cm
    - name: kubeconfig
  tasks:
    - name: started-webhook
      taskRef:
        name: send-to-webhook-slack
      params:
      - name: {{ $.Values.secret_slack_webhook }}
        value: "{{ include "generic.fullname" $ }}-{{ $.Values.secret_slack_webhook }}"
      - name: git_revision_owner
        value: $(params.git_revision_owner)
      - name: message
        value: "[{{ include "generic.fullname" $ }}] {{ $value.name }} Started"
      - name: bot-name
        value: "*TEKTON-stg-dummy-test*"
      - name: icon-emoji
        value: https://tekton.dev/favicons/favicon.ico
    - name: clone-git-repo
      taskRef:
        name: "{{ include "generic.fullname" $ }}-git-clone"
      params:
      - name: url
        value: {{ $value.git_source }} 
      - name: {{ $value.git_specifier }}
        value: $(params.git_revision)
      workspaces:
      - name: ssh-directory
        workspace: ssh-creds
      - name: output
        workspace: git-pvc
      runAfter:
        - started-webhook
    - name: build-and-push
      taskRef:
        name: "{{ include "generic.fullname" $ }}-kaniko"
      params:
        - name: IMAGE
          value: {{ $value.docker_registry }}:$(params.git_revision)
      runAfter:
        - clone-git-repo
      workspaces:
      - name: source
        workspace: git-pvc
      - name: dockerconfig
        workspace: docker-creds-cm
    - name: mid-webhook
      taskRef:
        name: send-to-webhook-slack
      params:
      - name: {{ $.Values.secret_slack_webhook }}
        value: "{{ include "generic.fullname" $ }}-{{ $.Values.secret_slack_webhook }}"
      - name: git_revision_owner
        value: $(params.git_revision_owner)
      - name: message
        value: "[{{ include "generic.fullname" $ }}] {{ $value.name }} Pushed {{ $value.docker_registry }}:$(params.git_revision)"
      - name: bot-name
        value: "*TEKTON-stg-dummy-test*"
      - name: icon-emoji
        value: https://tekton.dev/favicons/favicon.ico
      runAfter:
        - build-and-push
    - name: update-image
      taskRef:
        name: kubectl-restart-deployment
      params:
        - name: deployment
          value: {{ $value.deployment_name }}
        - name: namespace
          value: {{ $value.deployment_namespace }}
      runAfter:
        - build-and-push
      workspaces:
        - name: kubeconfig-dir
          workspace: kubeconfig
    - name: end-webhook
      taskRef:
        name: send-to-webhook-slack
      params:
      - name: {{ $.Values.secret_slack_webhook }}
        value: "{{ include "generic.fullname" $ }}-{{ $.Values.secret_slack_webhook }}"
      - name: git_revision_owner
        value: $(params.git_revision_owner)
      - name: message
        value: "INFO [{{ include "generic.fullname" $ }}] {{ $value.name }} Deployed {{ $value.deployment_namespace }}/{{ $value.deployment_name }}"
      - name: bot-name
        value: "*TEKTON-stg-dummy-test*"
      - name: icon-emoji
        value: https://tekton.dev/favicons/favicon.ico
      runAfter:
        - update-image
---
{{- end }}
{{- end }}